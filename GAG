-- SERVICES
local replicatedStorage = game:GetService("ReplicatedStorage")
local collectionService = game:GetService("CollectionService")
local players = game:GetService("Players")
local runService = game:GetService("RunService")
local localPlayer = players.LocalPlayer
local currentCamera = workspace.CurrentCamera

-- GUI SETUP
local screenGui = Instance.new("ScreenGui", localPlayer:WaitForChild("PlayerGui"))
screenGui.Name = "PetRandomizerUI"
screenGui.ResetOnSpawn = false

local frame = Instance.new("Frame", screenGui)
frame.Size = UDim2.new(0, 200, 0, 160)
frame.Position = UDim2.new(0, 10, 0.5, -80)
frame.BackgroundColor3 = Color3.fromRGB(45, 45, 45)
frame.BorderSizePixel = 0
frame.BackgroundTransparency = 0.1

-- TITLE
local title = Instance.new("TextLabel", frame)
title.Size = UDim2.new(1, 0, 0, 25)
title.Position = UDim2.new(0, 0, 0, -25)
title.BackgroundTransparency = 1
title.Text = "üêæ Pet Randomizer ‚ú®"
title.TextColor3 = Color3.new(1, 1, 1)
title.Font = Enum.Font.SourceSansBold
title.TextScaled = true

-- CREDIT
local credit = Instance.new("TextLabel", frame)
credit.Size = UDim2.new(1, 0, 0, 20)
credit.Position = UDim2.new(0, 0, 1, 0)
credit.BackgroundTransparency = 1
credit.Text = "Made by - zenki"
credit.TextColor3 = Color3.fromRGB(200, 200, 200)
credit.Font = Enum.Font.SourceSansItalic
credit.TextScaled = true

-- BUTTON CREATION FUNCTION
local function createButton(name, text, color, position)
	local button = Instance.new("TextButton")
	button.Name = name
	button.Text = text
	button.Size = UDim2.new(1, -10, 0, 40)
	button.Position = position
	button.Parent = frame
	button.BackgroundColor3 = color
	button.TextColor3 = Color3.new(1, 1, 1)
	button.Font = Enum.Font.SourceSansBold
	button.TextScaled = true
	button.BorderSizePixel = 0
	return button
end

-- BUTTONS
local randomizeButton = createButton("RandomizeButton", "üé≤ Randomize Pets", Color3.fromRGB(255, 165, 0), UDim2.new(0, 5, 0, 5))
local espButton = createButton("ESPButton", "üëÅ ESP: ON", Color3.fromRGB(40, 40, 40), UDim2.new(0, 5, 0, 50))
local autoRandomizeButton = createButton("AutoRandomizeButton", "‚úÖ Auto Randomize: OFF", Color3.fromRGB(0, 170, 0), UDim2.new(0, 5, 0, 95))

-- VARIABLES
local espEnabled = true
local autoRandomize = false

-- ESP LOGIC
local hatchFunction = getupvalue(getupvalue(getconnections(replicatedStorage.GameEvents.PetEggService.OnClientEvent)[1].Function, 1), 2)
local eggModels = getupvalue(hatchFunction, 1)
local eggPets = getupvalue(hatchFunction, 2)

local espCache = {}
local activeEggs = {}

local function getObjectFromId(objectId)
	for _, eggModel in ipairs(eggModels) do
		if eggModel:GetAttribute("OBJECT_UUID") == objectId then
			return eggModel
		end
	end
end

local function UpdateEsp(objectId, petName)
	if not espEnabled then return end
	local object = getObjectFromId(objectId)
	if not object or not espCache[objectId] then return end
	local eggName = object:GetAttribute("EggName")
	espCache[objectId].Text = `{eggName} | {petName}`
end

local function AddEsp(object)
	if object:GetAttribute("OWNER") ~= localPlayer.Name then return end
	local eggName = object:GetAttribute("EggName")
	local petName = eggPets[object:GetAttribute("OBJECT_UUID")]
	local objectId = object:GetAttribute("OBJECT_UUID")
	if not objectId then return end

	local label = Drawing.new("Text")
	label.Text = `{eggName} | {petName or "?"}`
	label.Size = 18
	label.Color = Color3.new(1, 1, 1)
	label.Outline = true
	label.OutlineColor = Color3.new(0, 0, 0)
	label.Center = true
	label.Visible = false

	espCache[objectId] = label
	activeEggs[objectId] = object
end

local function RemoveEsp(object)
	if object:GetAttribute("OWNER") ~= localPlayer.Name then return end
	local objectId = object:GetAttribute("OBJECT_UUID")
	if espCache[objectId] then
		espCache[objectId]:Remove()
		espCache[objectId] = nil
	end
	activeEggs[objectId] = nil
end

local function UpdateAllEsp()
	if not espEnabled then
		for _, label in pairs(espCache) do
			label.Visible = false
		end
		return
	end

	for objectId, object in pairs(activeEggs) do
		if not object or not object:IsDescendantOf(workspace) then
			activeEggs[objectId] = nil
			if espCache[objectId] then
				espCache[objectId].Visible = false
			end
			continue
		end

		local label = espCache[objectId]
		if label then
			local pos, onScreen = currentCamera:WorldToViewportPoint(object:GetPivot().Position)
			if onScreen then
				label.Position = Vector2.new(pos.X, pos.Y)
				label.Visible = true
			else
				label.Visible = false
			end
		end
	end
end

-- INITIATE EXISTING EGGS
for _, object in collectionService:GetTagged("PetEggServer") do
	task.spawn(AddEsp, object)
end

-- LISTEN FOR NEW EGGS
collectionService:GetInstanceAddedSignal("PetEggServer"):Connect(AddEsp)
collectionService:GetInstanceRemovedSignal("PetEggServer"):Connect(RemoveEsp)

-- HOOK EGG HATCHING EVENT
local old
old = hookfunction(getconnections(replicatedStorage.GameEvents.EggReadyToHatch_RE.OnClientEvent)[1].Function, newcclosure(function(objectId, petName)
	UpdateEsp(objectId, petName)
	return old(objectId, petName)
end))

-- UPDATE ESP EVERY FRAME
runService.PreRender:Connect(UpdateAllEsp)

-- BUTTON FUNCTIONALITY
espButton.MouseButton1Click:Connect(function()
	espEnabled = not espEnabled
	espButton.Text = espEnabled and "üëÅ ESP: ON" or "üëÅ ESP: OFF"
end)

autoRandomizeButton.MouseButton1Click:Connect(function()
	autoRandomize = not autoRandomize
	autoRandomizeButton.Text = autoRandomize and "‚úÖ Auto Randomize: ON" or "‚úÖ Auto Randomize: OFF"
end)

randomizeButton.MouseButton1Click:Connect(function()
	-- Replace with real pet randomization logic
	warn("Manual pet randomization triggered!")
end)
